{% extends 'sender/base.html' %}

{% block content %}
    {% load static %}
    {% load sender_tags %}
    {% load sender_filters %}
    {% load user_agents %}

<div class="container position-relative mt-5 mb-0">
    <div class="row">
        <div class="col-lg-4 col-xl-3 col-md-12 col-sm-12 col-12">
            <div class="card border-success mb-md-0 mb-sm-0 mb-lg-5 mb-xl-5 mb-0">
              <div class="card-header text-center bg-success">
                  <h5 class="text-light">{{ object.title }}</h5>
              </div>
              <div class="card-body pb-0">
                    <h6 class="card-subtitle mb-2 text-muted">Настройки рассылки</h6>
                    <table class="table table-info mb-0">
                        <tbody>
                            <tr>
                                <td class="col-4">График:</td>
                                <td class="col-8">{{ object.periodicity }}</td>
                            </tr>
                            <tr>
                                <td class="col-4">Время:</td>
                                <td class="col-8">{{ object.hour }}:{% if object.minute < 10 %}0{{ object.minute }}
                                                                    {% else %}{{ object.minute }}
                                                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
               </div>
               {% if object.periodicity == period_mailing_week %}
                <div class="card-footer mx-3 px-2 mt-0 {% if not object.weekdays %}td-table-danger{% else %}td-table-info{% endif %}">
                    <span>
                            {% if not object.weekdays %}
                                <a class="icon-update-cron" href="{% url 'sender:update_weekday' object.pk %}">
                                    <img src="{% static 'img/updateblack.png' %}">
                                </a>
                                <a class="link-update-cron" href="{% url 'sender:update_weekday' object.pk %}">
                                    <strong>Укажите дни</strong>
                                </a>
                            {% else %}
                                <a class="icon-update-cron" href="{% url 'sender:update_weekday' object.pk %}">
                                    <img src="{% static 'img/updateblack.png' %}">
                                </a>
                                <a class="link-update-cron" href="{% url 'sender:update_weekday' object.pk %}">
                                    <strong>Дни</strong>
                                </a>&nbsp;&nbsp;{{ object.weekdays_text }}
                            {% endif %}
                    </span>
               </div>
                {% elif object.periodicity == period_mailing_month %}
               <div class="card-footer mx-3 px-2 mt-0 {% if not object.monthdates %}td-table-danger{% else %}td-table-info{% endif %}">
                    <span>
                            {% if not object.monthdates %}
                                <a class="icon-update-cron" href="{% url 'sender:update_monthdate' object.pk %}">
                                    <img src="{% static 'img/updateblack.png' %}">
                                </a>
                                <a class="link-update-cron" href="{% url 'sender:update_monthdate' object.pk %}">
                                    <strong>Укажите даты</strong>
                                </a>
                            {% else %}
                                <a class="icon-update-cron" href="{% url 'sender:update_monthdate' object.pk %}">
                                    <img src="{% static 'img/updateblack.png' %}">
                                </a>
                                <a class="link-update-cron" href="{% url 'sender:update_monthdate' object.pk %}">
                                    <strong>Даты</strong>
                                </a>&nbsp;&nbsp;{{ object.monthdates_text }}
                            {% endif %}
                    </span>
                </div>
              {% endif %}
                <div class="card-footer border-0 px-0">
                      <div class="row mx-1">
                          <div class="col-6 text-center">
                               <a class="p-1 btn btn-outline-primary {% if request|is_tablet or request.META.HTTP_USER_AGENT|checkuseragenttablet %}w-75
                                                                        {% else %}w-100{% endif %}" href="{% url 'sender:update_mailing' object.pk %}">
                                    <strong>Изменить</strong>
                               </a>
                          </div>
                          <div class="col-6 text-center">
                              <a class="p-1 btn btn-outline-danger {% if request|is_tablet or request.META.HTTP_USER_AGENT|checkuseragenttablet %}w-75
                                                                        {% else %}w-100{% endif %}" href="{% url 'sender:delete_mailing' object.pk %}">
                                <strong>Удалить</strong>
                              </a>
                          </div>
                      </div>
                 </div>
                <div class="card-footer py-1 text-center {% if object.periodicity == period_mailing_week and not object.weekday %}bg-danger
                                                    {% elif object.periodicity == period_mailing_month and not object.monthdate %}bg-danger
                                                    {% elif not object.mail_dump %}bg-danger
                                                    {% else %}bg-success
                                                    {% endif %}">
                    <span class="text-light">
                        <strong>{% if object.status == status_mailing_done %}Рассылка завершена
                                {% elif object.periodicity == period_mailing_week and not object.weekdays %} Добавьте дни недели рассылки
                                {% elif object.periodicity == period_mailing_month and not object.monthdates %} Добавьте даты месяца рассылки
                                {% elif not object.mail_dump %} Загрузите базу мейлов {% else %} Готово к работе! <br> Email: {{ object.from_email }}
                                    <a class="update-mailing-detail" style="text-decoration: underline" href="{% url 'sender:update_mailing' object.pk %}"><br>Изменить email</a>
                                {% endif %}</strong></span>
                </div>
                {% if object.status == status_mailing_done %}
                <div class="card-footer bg-success text-center border-0 pt-0">
                    <a class="btn btn-outline-light" href="{% url 'sender:restart_mailing' object.pk %}"><strong>Перезапустить</strong></a>
                </div>
                {% endif %}
             </div>
         </div>
        <div class="col-lg-8 col-xl-9 col-md-12 col-sm-12 col-12">
            <div class="card border-0 mb-5">
                <div class="card-header text-center" style="display: flex;">
                    {% if not letters %}
                    <h5 class="text-center mt-lg-2 mt-md-2">Пока нет писем</h5>
                    {% endif %}
                    {% if letters %}
                    <div class="mt-3" style="margin-right: auto">
                        <strong><span>Писем: {% count_obj letters %}</span></strong>
                        {% if sent_letters_count > 0 %}
                        &nbsp;&nbsp;<img class="filter-icon" src="{% static 'img/filter.png' %}" onclick="openFilter()" title="Скрыть/показать отправленные">
                        {% endif %}
                        <div class="card filter-letter" id="Filter">
                            <div class="card-header d-flex bg-success py-0 px-0">
                                <img class="float-end close-form" src="{% static 'img/close.png' %}" style="margin-left: auto;" onclick="closeFilter()">
                            </div>
                            <div class="card-body py-1">
                                <div class="row">
                                    <div class="col-12">
                                        <option class="option-filter" selected="" onclick="hideSentLetters();">Скрыть отправленные</option>
                                    </div>
                                    <div class="col-12">
                                        <option class="option-filter" onclick="showSentLetters();">Показать все письма</option>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <a style="margin-left: auto" class="p-1 btn btn-outline-success w-50 my-2" href="{% url 'sender:create_letter' object.pk %}">
                        {% if request|is_mobile or request.META.HTTP_USER_AGENT|checkuseragentphone %}
                            <strong>Новое письмо</strong>
                        {% else %}
                            <strong>Создать новое письмо</strong>
                        {% endif %}
                    </a>
                </div>
              <div class="card-body px-0 py-0">
                    {% if letters %}
                    <div class="row td-table-info mb-0 mx-0">
                        {% if not request|is_mobile or not request.META.HTTP_USER_AGENT|checkuseragentphone %}
                            <div class="col-3 my-2">
                                <strong>Тема</strong>
                            </div>
                        {% else %}
                            <div class="col-6 my-2">
                                <strong>Тема</strong>
                            </div>
                        {% endif %}
                        {% if not request|is_mobile or not request.META.HTTP_USER_AGENT|checkuseragentphone %}
                            <div class="col-6 my-2">
                                <strong>Содержание письма</strong>
                            </div>
                        {% endif %}
                        {% if not request|is_mobile or not request.META.HTTP_USER_AGENT|checkuseragentphone %}
                            <div class="col-2 my-2 px-0">
                                <strong>Статус</strong>
                            </div>
                        {% else %}
                            <div class="col-6 my-2">
                                <strong>Статус</strong>
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                <div class="container">
                    <div class="row d-flex">
                    {% for letter in letters %}
                        <div class="card col-12" style="border-radius: 0" {% if letter.status == status_letter_sent  %}id="SentLetter"{% endif %}>
                            <div class="row py-2 {% if letter.status == status_letter_sent  %}td-table-success{% endif %}">
                                {% if not request|is_mobile or not request.META.HTTP_USER_AGENT|checkuseragentphone %}
                                    <div class="col-3">
                                        {{ letter.title }}
                                    </div>
                                {% else %}
                                    <div class="col-6">
                                        {{ letter.title }}
                                    </div>
                                {% endif %}
                                {% if not request|is_mobile or not request.META.HTTP_USER_AGENT|checkuseragentphone %}
                                    <div class="col-6">
                                        {{ letter.content|truncatechars:200 }}
                                    </div>
                                {% endif %}
                                {% if not request|is_mobile or not request.META.HTTP_USER_AGENT|checkuseragentphone %}
                                    <div class="col-2">
                                        <div class="row">
                                            <div class="col-11 px-0">
                                                {{ letter.status }} {% if letter.status != status_letter_sent %}
                                                                    Очередь:<strong>#{{ forloop.counter|calcposition:sent_letters_count }}
                                                                    {% endif %}</strong>
                                            </div>
                                            <div class="col-1 px-1">
                                                {% if not request|is_mobile or not request.META.HTTP_USER_AGENT|checkuseragentphone %}
                                                    {% if letter.status != status_letter_sent %}
                                                        <a href="{{ letter.get_absolute_url }}">
                                                            <img class="mb-1 mx-3" src="{% static "img/update.png" %}" title="Редактировать письмо">
                                                        </a>
                                                    {% endif %}
                                                        <a href="{% url 'sender:delete_letter' object.pk letter.pk %}#{{ forloop.counter }}">
                                                            <img class="mb-1 mx-3" src="{% static "img/delete.png" %}" title="Удалить письмо">
                                                        </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="col-6">
                                        <div class="container px-0">
                                            <div class="row">
                                                <div class="col-9">
                                                    {{ letter.status }} {% if letter.status != status_letter_sent %}
                                                                        Очередь:<strong>#{{ forloop.counter|calcposition:sent_letters_count }}
                                                                        {% endif %}</strong>
                                                </div>
                                                <div class="col-3">
                                                    <a href="{{ letter.get_absolute_url }}">
                                                        <img style="margin-left: auto" class="mb-1" src="{% static "img/updatemobile.png" %}" title="Редактировать письмо">
                                                    </a>
                                                    <a href="{% url 'sender:delete_letter' object.pk letter.pk %}">
                                                        <img style="margin-left: auto" class="mb-1" src="{% static "img/deletemobile.png" %}" title="Удалить письмо">
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                </div>
              </div>
            </div>
        </div>
    </div>
</div>

<script>
function openFilter() {document.getElementById("Filter").style.display = "block";}
function closeFilter() {document.getElementById("Filter").style.display = "none";}
function showSentLetters() {
    document.getElementById("SentLetter").style.display = "block";
    document.getElementById("Filter").style.display = "none";
}
function hideSentLetters() {
    document.getElementById("SentLetter").style.display = "none";
    document.getElementById("Filter").style.display = "none";
}
</script>
{% endblock %}